name: Auto Release on Push to Main

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - '.github/**'
      - 'LICENSE'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version calculation

      - name: Calculate version
        id: version
        run: |
          # Get the latest tag or default to v1.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Increment patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$(date +%Y%m%d%H%M)" >> $GITHUB_OUTPUT

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Bubblewrap
        run: npm install -g @bubblewrap/cli

      - name: Accept Android SDK licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Update twa-manifest with version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_CODE="${{ steps.version.outputs.version_code }}"
          
          # Update manifest version
          jq --arg version "$VERSION" \
             --argjson versionCode "$VERSION_CODE" \
             '.appVersionName = $version | .appVersionCode = ($versionCode | tonumber)' \
             twa-manifest.json > twa-manifest-updated.json
          mv twa-manifest-updated.json twa-manifest.json

      - name: Generate signing key
        run: |
          keytool -genkeypair \
            -alias patreonreader \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore android.keystore \
            -storepass ${{ secrets.KEYSTORE_PASSWORD || 'android' }} \
            -keypass ${{ secrets.KEYSTORE_PASSWORD || 'android' }} \
            -dname "CN=Patreon Reader, OU=Development, O=Ecleptic, L=Unknown, ST=Unknown, C=US"

      - name: Initialize Bubblewrap project
        run: bubblewrap init --manifest twa-manifest.json --skipPwaValidation
        env:
          BUBBLEWRAP_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'android' }}
          BUBBLEWRAP_KEY_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'android' }}

      - name: Build APK
        run: bubblewrap build --skipPwaValidation
        env:
          BUBBLEWRAP_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'android' }}
          BUBBLEWRAP_KEY_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'android' }}

      - name: Rename artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ -f "app-release-signed.apk" ]; then
            mv app-release-signed.apk PatreonReader-v${VERSION}.apk
          fi
          if [ -f "app-release-bundle.aab" ]; then
            mv app-release-bundle.aab PatreonReader-v${VERSION}.aab
          fi

      - name: Generate release notes
        id: notes
        run: |
          # Get commits since last tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ]; then
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s" --no-merges | head -20)
          else
            COMMITS=$(git log --pretty=format:"- %s" --no-merges -10)
          fi
          
          # Write to file to handle multiline
          echo "## Changes" > release_notes.md
          echo "" >> release_notes.md
          echo "$COMMITS" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "Download the APK and install on your Android device." >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            PatreonReader-*.apk
            PatreonReader-*.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
